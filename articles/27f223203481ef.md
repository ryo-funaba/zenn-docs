---
title: "Dockerãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹"
emoji: "ğŸ³"
type: "tech"
topics: ["docker","ssh", "git"]
published: false
---

# çµè«–

Docker ãƒ“ãƒ«ãƒ‰æ™‚ã« `-ssh` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ›ã‚¹ãƒˆã® SSH ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†æŒ‡å®š

```bash
docker build --ssh default .
```

::::message alert

ãƒãƒƒãƒˆä¸Šã§ãŸã¾ã«è¦‹ã‹ã‘ã‚‹ `Dockerfile` å†…ã§ãƒ›ã‚¹ãƒˆã®ç§˜å¯†éµã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–¹æ³•ã¯éæ¨å¥¨ã§ã™ã€‚ï¼ˆãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼‰

ç†ç”±ã¯ç§˜å¯†æƒ…å ±ã‚’å«ã‚“ã  Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…¬é–‹ã—ã¦ã—ã¾ã†ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚

::::

# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ã€Œã‚Šã‚‡ã†ã€ã¨ç”³ã—ã¾ã™ã€‚

çªç„¶ã§ã™ãŒã¿ãªã•ã‚“ã®ç¾å ´ã§ã¯ Docker ã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ

ç§ã¯æœ€è¿‘æ¥­å‹™ã§ç’°å¢ƒæ§‹ç¯‰ã®ç°¡ç´ åŒ–ãƒ»é–‹ç™ºç’°å¢ƒã®çµ±ä¸€åŒ–ã‚’ç›®çš„ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« Docker ç’°å¢ƒã‚’å°å…¥ã—ã¾ã—ãŸã€‚

ãã®éš›ã€ Docker ãƒ“ãƒ«ãƒ‰æ™‚ã«ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã€ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€è‰²ã€…èª¿æŸ»ã—ãŸçµæœã‚’å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸå®Ÿéš›ã«ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹ Docker Compose ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‚±ãƒ¼ã‚¹ã‚‚æœ€å¾Œã«è§£èª¬ã—ã¾ã™ã€‚

é–“é•ã„ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§ã”æŒ‡æ‘˜é ‚ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

# ç’°å¢ƒ

- macOS Monterey v12.6
- Docker v20.10.17
- Docker compose v2.7.0

:::message

`-ssh` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€Docker ã¯ v18.09 ä»¥ä¸Šã€Docker compose ã¯ v2.4.0 ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::

# æ‰‹é †

1. GitHub ã¨ SSH æ¥ç¶šã™ã‚‹è¨­å®š
    - è§£èª¬è¨˜äº‹ã¯[ã“ã¡ã‚‰](https://zenn.dev/schnell/articles/0e1c2e9db5c08d)
    - **ssh-agentã«GitHubã®ç§˜å¯†éµã‚’ç™»éŒ²ã™ã‚‹**
      - `ssh-add -K ~/.ssh/your_secret_key`

2. `Dockerfile` ã‚’ä½œæˆ

    ```Dockerfile:Dockerfile
    # syntax=docker/dockerfile:1
    FROM alpine

    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    RUN apk update && \
        apk --no-cache add \
        git \
        openssh

    # érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½¿ç”¨
    ENV USER zenn
    ENV HOME /home/$USER
    RUN addgroup -S $USER && \
        adduser -S -u 1000 -G $USER $USER && \
        chown -R $USER:$USER $HOME
    USER $USER

    WORKDIR $HOME

    # GitHubã«SSHæ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®š
    RUN mkdir -p -m 0700 ~/.ssh && \
        ssh-keyscan github.com >> ~/.ssh/known_hosts && \
        git config --global url.git@github.com:.insteadOf https://github.com/

    # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
    RUN --mount=type=ssh,uid=1000 \
        git clone git@github.com:myorg/myproject.git
    ```

    - å…ˆé ­ã« `# syntax=docker/dockerfile:1` ã‚’è¨˜è¼‰
    - [ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://docs.docker.jp/develop/develop-images/dockerfile_best-practices.html#user)ã«å¾“ã„ã€é Root ãƒ¦ãƒ¼ã‚¶ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†è¨­å®š
    - ãƒ›ã‚¹ãƒˆä¸Šã® ssh-agent ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã« `--mount=type=ssh` ã‚’æŒ‡å®š
    - ä½¿ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã‚’ `uid=1000` ã§æŒ‡å®š

3. ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰

   ```bash
   $ export DOCKER_BUILDKIT=1
   $ docker build -t sample_docker_ssh --ssh default .
   ```

   - BuildKit ã§ã®æ§‹ç¯‰ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ã« `DOCKER_BUILDKIT=1` ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
   - `--ssh` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ãƒ›ã‚¹ãƒˆä¸Šã® ssh-agent ã¸æ¥ç¶šã™ã‚‹ã‚½ã‚±ãƒƒãƒˆã‚’æŒ‡å®š

4. ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªãŒã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚ŒãŸã‹ç¢ºèª

   ```bash
   $ docker run -it sample_docker_ssh

   # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œ
   $ ls
   myproject
   ```

5. ä»¥ä¸Š

# Docker Compose ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‚±ãƒ¼ã‚¹

1. `docker-compose.yml` ã‚’ä½œæˆ

   ```yaml:docker-compose.yml
   version: "3.9"
   services:
     app:
       image: sample_docker_ssh
       build:
         context: .
         dockerfile: Dockerfile
       container_name: sample_docker_ssh
       tty: true
       working_dir: /home/zenn/myproject
   ```

2. ãƒ“ãƒ«ãƒ‰

    ```bash
    $ export COMPOSE_DOCKER_CLI_BUILD=1
    $ export DOCKER_BUILDKIT=1
    $ docker compose build --ssh default
    ```

3. ä»¥ä¸Š

# ã€ãŠã¾ã‘ã€‘Makefileã®ä½œæˆ

`Makefile` ã‚’ä½œæˆã™ã‚‹ã¨ã€ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ãŒç°¡å˜ã« Docker ã®ç’°å¢ƒæ§‹ç¯‰ãŒè¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚

::::details Makefile

```Makefile
.PHONY: help build up down restart exec logs ps setEnv

help: ## Show options
  @grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
    awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

build: setEnv ## Build docker container
  docker compose build --ssh default

up: ## Do docker compose up in detached mode
  docker compose up -d

down: ## Do docker compose down
  docker compose down

restart: down up ## Do docker compose restart

exec: up ## Execute a command in a running app container
  docker compose exec -it app ash

logs: ## Tail docker compose logs
  docker compose logs -f

ps: ## Check container status
  docker compose ps

setEnv: ## Set Env to use SSH in Docker container
  export COMPOSE_DOCKER_CLI_BUILD=1 export DOCKER_BUILDKIT=1
```

::::

```bash
$ make help
help                 Show options
build                Build docker container
up                   Do docker compose up in detached mode
down                 Do docker compose down
restart              Do docker compose restart
exec                 Execute a command in a running app container
logs                 Tail docker compose logs
ps                   Check container status
setEnv               Set Env to use SSH in Docker container
```

# å‚è€ƒ

[Dockerå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆæ—¥æœ¬èªç‰ˆï¼‰](https://docs.docker.jp/develop/develop-images/build_enhancements.html)
